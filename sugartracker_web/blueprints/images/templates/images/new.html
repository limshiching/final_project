{% extends "_layout.html" %}
{% block header %}
<style>
    body{
        height: 100%;
    }
    #predictions .food-photo,
    #predictions .nutrition {
        min-height: 370px;
        position: relative;
        float: left;
        margin: 1rem auto;
        padding-top: 25px;
        background: #fff;
        background-position: center center;
        background-repeat: no-repeat;
        background-size: contain;
        text-align: center;
        width: 50%;
    }
    #predictions .step {
        position: absolute;
        top:0.5rem;
    }
    #predictions .nutrition {
        float:right;
    }
    #predictions .step span{
        border-radius: 50%;
        height: 1rem;
        width: 1rem;
        display: inline-block;
    }
    .wrapper {
        background: #fff;
        border-radius: 5px;
        width: 650px;
        
    }
</style>
{% endblock %}
{% block content %}

<div class="wrapper">
    <h1 class="align-item-center" >Sugar Level in food</h1>

    <form action="#" class="text-align-center">
        <input type="file" id="filename" size="100" class="align-item-center" />
        <button onclick="predict_click($('#filename').val(), 'file'); return false;" class="btn btn-primary">Get my Nutritional Breakdown!</button>
    </form>

    <div class="container">
        <div id="predictions" >
            <div class="food-photo" >
                <div class="step"><span>1</span> Upload a Photo</div>
            </div>
            <div class="nutrition" >
                <div class="step">2. Get a Nutritional Breakdown</div>
                <br>
                <div id="concepts"></div>
                <button id="save-results" class="btn btn-primary">Save Results</button>
            </div>
        </div>
    </div>
</div>

<div class="container-fluid">
    <p> If no image, click <a class="nav-link" href=" {{ url_for('foods.new') }}"> here </a> to key in food details: </p>

</div>

<script>
let myClarifaiApiKey = '068aa83b2a734fdd9275ab8a7dd0d66a';
let chosenConcepts = []
let saveRsltBtn = document.getElementById('save-results')

$('#filename').change(() => {
    $('#concepts').html('')
})

let app = new Clarifai.App({apiKey: myClarifaiApiKey});
app.models.initModel({id:Clarifai.FOOD_MODEL})

function predict_click(value, source) {
    let preview = $(".food-photo");
    let file    = document.querySelector("input[type=file]").files[0];
    let loader  = "https://s3.amazonaws.com/static.mlh.io/icons/loading.svg";
    let reader  = new FileReader();

  // load local file picture
    reader.addEventListener("load", function () {
        preview.attr('style', 'background-image: url("' + reader.result + '");');
        doPredict({ base64: reader.result.split("base64,")[1] },queryFood);
    }, false);
    console.log(reader)

    if (file) {
        reader.readAsDataURL(file);
        // $('#concepts').html('<img src="' + loader + '" class="loading" />');
    } else { alert("No file selcted!"); }
}

function doPredict(value,callback) {
    console.log(value)
    app.models.predict(Clarifai.FOOD_MODEL, value).then(function(response) {
        console.log(response)
        if(response.rawData.outputs[0].data.hasOwnProperty("concepts")) {
            let concepts = response.rawData.outputs[0].data.concepts;

            if (concepts.length > 10){
                concepts = concepts.slice(0, 9)
            }

            // concepts = concepts.map((foodItem) => {
            //     return foodItem.name
            // })


            // let uniqueItems = Array.from(new Set(concepts))
            concepts.map((concept) => {
                $('#concepts').append(`<li style="list-style: none;"><input class="concepts-check" type="checkbox" value="${concept.name}">${concept.name}</input></li>`);
            })

            let conceptsCheck = document.querySelectorAll('.concepts-check')
            
            conceptsCheck.forEach((option) => {
                option.addEventListener('change',(e) => {
                    if(chosenConcepts.includes(e.target.value)){
                        chosenConcepts.splice(chosenConcepts.indexOf(e.target.value), 1)
                    } else {
                        chosenConcepts.push(e.target.value)
                    }
                    console.log(chosenConcepts)
                })
            })
        }
    });
}

function sentData(concepts){
    fetch("http://localhost:5000/images/check", {
        method: "POST",
        body: JSON.stringify(concepts),
        headers: {
            'Content-Type': 'application/json'
        }
    }).then((response) => {
        return response.json();
    }).then((response) => {
        console.log(response);
    })
}

saveRsltBtn.addEventListener('click', () => sentData(chosenConcepts))


function queryFood() {
    $('#concepts').append( 
        `<form id="query" action="{{ url_for('foods.search') }}" method="POST">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                <div class="form-group">
                <label for="item_name"> Did we miss out anything?  </label>
                <input type="text" name="item_name" class="form-control" />
                </div>

                <button type="submit" class="btn btn-primary">Submit</button>
        </form>`)

    concepts.map((concept) => {
        $('#concepts').append(`${query.item_name}'`)
    })
}


</script>

{% endblock %}

<!-- git checkout master -->
<!-- git pull origin master --rebase -->
<!-- git checkout <your branch> -->
<!-- git merge master -->

